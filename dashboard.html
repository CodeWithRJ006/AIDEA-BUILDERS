<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendrix - Smart Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.5.7/dist/face-api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto; 
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-container {
            position: relative;
            display: inline-block;
            margin-top: 1rem;
            max-width: 100%;
        }
        #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
            max-width: 100%;
            height: auto;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">

    <aside class="w-64 bg-gray-900 text-gray-400 p-6 flex flex-col shadow-lg">
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white">Attendrix AI</h1>
        </div>
        <nav class="flex-1">
            <ul>
                <li class="mb-4">
                    <div class="text-xs uppercase font-semibold text-gray-500 tracking-wider">Menu</div>
                </li>
                <li class="mb-2">
                    <a href="#" class="flex justify-between items-center py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="toggleDropdown(event)">
                        <span>Class</span>
                        <i class="fas fa-caret-down text-sm"></i>
                    </a>
                    <ul class="ml-4 mt-2 space-y-2 hidden">
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classA')">Class A</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classB')">Class B</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classC')">Class C</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classD')">Class D</a></li>
                    </ul>
                </li>
                <li class="mb-2">
                    <a href="#" class="block py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="showContent('attendanceReport')">Report</a>
                </li>
                <li class="mb-2">
                    <a href="#" class="block py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="showContent('settings')">Settings</a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="flex-1 p-8 overflow-y-auto">
        <header class="bg-white rounded-lg shadow-md p-4 mb-8 flex justify-end items-center">
            <nav>
                <ul class="flex items-center space-x-6 text-gray-600 font-medium">
                    <li><a href="#" class="hover:text-indigo-600 transition duration-300" onclick="showContent('dashboard')">Home</a></li>
                </ul>
            </nav>
        </header>

        <div id="dashboardContent" class="content-section">
            <div class="p-8 bg-white rounded-lg shadow-md h-full">
                <h2 class="text-3xl font-bold mb-4 text-gray-800">Welcome to your Dashboard</h2>
                <p class="text-gray-600">Please select a class from the menu to manage attendance.</p>
            </div>
        </div>

        <div id="attendanceContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800" id="attendanceTitle">Class Attendance</h2>
            
            <div class="card mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">1. Upload Known Faces (Student Dataset)</h3>
                <p class="text-gray-500 mb-4">Select multiple individual images. **Filename must be the student's name (e.g., `sai ganesh.jpg`).**</p>
                <input type="file" id="knownFacesInput" accept="image/*" multiple class="w-full text-gray-700 bg-gray-100 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                <div id="knownFacesContainer" class="mt-4 flex flex-wrap gap-4"></div>
            </div>
            
            <div class="flex justify-center gap-4 mb-8">
                <button id="recognizeButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out disabled:opacity-50" disabled>
                    Take Attendance
                </button>
            </div>

            <div class="card mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">2. Upload Group Photo</h3>
                <p class="text-gray-500 mb-4">Select the group photo to scan and mark attendance.</p>
                <input type="file" id="groupPhotoInput" accept="image/jpeg, image/png" class="w-full text-gray-700 bg-gray-100 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                <div class="image-container mx-auto" id="groupPhotoContainer">
                    <img id="groupPhoto" class="max-w-full h-auto rounded-lg shadow-xl">
                    <canvas id="outputCanvas"></canvas>
                </div>
            </div>

            <div id="statusMessage" class="text-center text-blue-600 mb-4 font-semibold text-lg p-2 bg-blue-50 rounded">Loading AI models...</div>
            <div id="attendanceResults" class="hidden mt-8"></div>
        </div>
        
        <div id="attendanceReportContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Attendance Report</h2>
            <p class="text-gray-600 mb-6">Attendance records will appear here.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Present</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Absent</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">2025-09-19</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Class A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">28</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">2</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600"><a href="#">View</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="settingsContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Settings</h2>
            <p class="text-gray-600">Settings placeholder.</p>
        </div>

        <div id="helpContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Help & Support</h2>
            <p class="text-gray-600">Contact support for assistance.</p>
        </div>
    </div>

    <script>
        let currentClassId = '';
        const studentDatabase = {
            classA: ['ganesh', 'sai charan', 'madhan', 'lal shah', 'prasana kumar', 'abhishek', 'anudeep', 'mustafa', 'akif', 'ashok', 'pavan', 'chandraa sekhar', 'murari', 'arun', 'kaushal', 'chandan', 'sai ganesh', 'shaheid'],
            classB: ['kevin', 'lisa', 'mike', 'nancy', 'oscar', 'paul', 'quinn', 'rachel', 'sam', 'tina'],
            classC: ['umar', 'vicky', 'will', 'xena', 'yara', 'zane', 'alex', 'bella', 'cody', 'diana'],
            classD: ['ethan', 'fiona', 'george', 'hannah', 'isaac', 'jasmine', 'kyle', 'laura', 'mark', 'nora']
        };

        const knownFacesInput = document.getElementById('knownFacesInput');
        const groupPhotoInput = document.getElementById('groupPhotoInput');
        const knownFacesContainer = document.getElementById('knownFacesContainer');
        const groupPhotoImg = document.getElementById('groupPhoto');
        const outputCanvas = document.getElementById('outputCanvas');
        const recognizeButton = document.getElementById('recognizeButton');
        const statusMessage = document.getElementById('statusMessage');
        const attendanceTitle = document.getElementById('attendanceTitle');
        const attendanceResults = document.getElementById('attendanceResults');

        let labeledDescriptors = [];
        let faceMatcher;
        
        // **STRICTEST THRESHOLD** to prevent misidentification.
        const MATCH_THRESHOLD = 0.5; 

        // --- Core Functions ---

        async function loadModels() {
            statusMessage.textContent = 'Loading AI models... please wait (Check console for network errors if stuck)';
            recognizeButton.disabled = true;
            try {
                const modelPath = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await faceapi.nets.ssdMobilenetv1.loadFromUri(modelPath);
                await faceapi.nets.faceLandmark68Net.loadFromUri(modelPath);
                await faceapi.nets.faceRecognitionNet.loadFromUri(modelPath);
                statusMessage.textContent = 'AI Models loaded successfully! Select a class and upload faces to begin.';
            } catch (error) {
                console.error("Failed to initialize face-api models:", error);
                statusMessage.innerHTML = "ðŸ”´ **ERROR:** Failed to load AI models. **You MUST run this file using a local web server** (e.g., Python `http.server` or VS Code Live Server). Double-clicking will not work.";
            }
        }

        // --- UI Functions ---

        function showContent(contentId) {
            const allContentSections = document.querySelectorAll('.content-section');
            allContentSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(contentId + 'Content').classList.remove('hidden');
        }

        window.toggleDropdown = (event) => {
            event.preventDefault();
            const dropdown = event.target.closest('li').querySelector('ul');
            dropdown.classList.toggle('hidden');
        };

        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
        };

        window.showAttendanceContent = (classId) => {
            currentClassId = classId;
            showContent('attendance');
            attendanceTitle.textContent = `${classId.charAt(0).toUpperCase() + classId.slice(1)} Attendance`;
            statusMessage.textContent = `Selected ${classId.toUpperCase()}. Upload known faces and group photo.`;
            clearAttendanceView();
        };

        function clearAttendanceView() {
            knownFacesInput.value = '';
            groupPhotoInput.value = '';
            knownFacesContainer.innerHTML = '';
            groupPhotoImg.src = '';
            const ctx = outputCanvas.getContext('2d');
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            attendanceResults.classList.add('hidden');
            labeledDescriptors = [];
            recognizeButton.disabled = true;
        }

        function checkReadyToRecognize() {
            if (labeledDescriptors.length > 0 && groupPhotoImg.src) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD); 
                recognizeButton.disabled = false;
                statusMessage.textContent = `Ready! ${labeledDescriptors.length} known faces loaded. Strictness: ${MATCH_THRESHOLD}`;
            } else {
                recognizeButton.disabled = true;
            }
        }
        
        // --- Face Recognition Logic ---

        async function createLabeledFaceDescriptors(files) {
            const descriptors = [];
            let facesFound = 0;
            statusMessage.textContent = `Processing known faces for ${currentClassId}... (0/${files.length})`;
            knownFacesContainer.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const label = file.name.split('.')[0].toLowerCase().trim(); 

                if (!studentDatabase[currentClassId] || !studentDatabase[currentClassId].includes(label)) {
                    console.warn(`Skipping file: ${file.name}. Label '${label}' not found in ${currentClassId} database.`);
                    continue;
                }

                try {
                    const img = await faceapi.bufferToImage(file);
                    const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

                    if (detection) {
                        descriptors.push(new faceapi.LabeledFaceDescriptors(label, [detection.descriptor]));

                        const imgPreview = document.createElement('img');
                        imgPreview.src = URL.createObjectURL(file);
                        imgPreview.alt = label;
                        imgPreview.title = label;
                        imgPreview.className = "w-24 h-24 object-cover rounded-full border-2 border-green-500 shadow-md";
                        knownFacesContainer.appendChild(imgPreview);
                        facesFound++;
                    } else {
                        console.log(`Could not detect face in image: ${file.name}`);
                    }
                    statusMessage.textContent = `Processing known faces for ${currentClassId}... (${i + 1}/${files.length} files processed, ${facesFound} faces detected)`;

                } catch (e) {
                    console.error(`Error processing file ${file.name}:`, e);
                }
            }
            
            if (facesFound === 0) {
                statusMessage.textContent = 'No known faces were successfully detected. Check file names and photo quality.';
            } else {
                statusMessage.textContent = `${facesFound} known faces processed. Ready for recognition.`;
                labeledDescriptors = descriptors;
            }
            checkReadyToRecognize();
        }

        // --- Event Listeners ---
        
        knownFacesInput.addEventListener('change', (event) => {
            if (!currentClassId) {
                statusMessage.textContent = "Please select a class first!";
                knownFacesInput.value = '';
                return;
            }
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                createLabeledFaceDescriptors(files);
            }
        });

        groupPhotoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const imageUrl = URL.createObjectURL(file);
                groupPhotoImg.src = imageUrl;
                groupPhotoImg.onload = () => {
                    outputCanvas.width = groupPhotoImg.offsetWidth;
                    outputCanvas.height = groupPhotoImg.offsetHeight;
                    checkReadyToRecognize();
                };
            }
        });

        recognizeButton.addEventListener('click', async () => {
            if (!groupPhotoImg.src || labeledDescriptors.length === 0) {
                statusMessage.textContent = "Please upload both a group photo and known faces.";
                return;
            }
            statusMessage.textContent = 'Scanning group photo for faces...';
            recognizeButton.disabled = true;

            const detectionOptions = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 });
            
            const detections = await faceapi.detectAllFaces(groupPhotoImg, detectionOptions)
                                            .withFaceLandmarks()
                                            .withFaceDescriptors();

            if (detections.length === 0) {
                statusMessage.textContent = 'No faces detected in the group photo. Please try a clearer image.';
                recognizeButton.disabled = false;
                return;
            }

            const displaySize = { width: groupPhotoImg.offsetWidth, height: groupPhotoImg.offsetHeight };
            faceapi.matchDimensions(outputCanvas, displaySize);
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            const ctx = outputCanvas.getContext('2d');
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height); 

            const presentStudents = new Set();
            const allStudents = new Set(studentDatabase[currentClassId]);
            let unknownFacesCount = 0;

            resizedDetections.forEach(detection => {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                const box = detection.detection.box;
                let label = bestMatch.label;
                const distance = Math.round(bestMatch.distance * 100) / 100;
                
                let drawLabel;
                let boxColor;

                if (label === 'unknown') {
                    unknownFacesCount++;
                    drawLabel = `UNKNOWN PERSON (${distance})`;
                    boxColor = 'red';
                } else {
                    presentStudents.add(label);
                    drawLabel = `${label.toUpperCase()} (${distance})`;
                    boxColor = 'green';
                }
                
                const drawBox = new faceapi.draw.DrawBox(box, { label: drawLabel, boxColor: boxColor, lineWidth: 2 });
                drawBox.draw(outputCanvas);
            });

            // Calculate and Display Attendance
            const presentList = Array.from(presentStudents);
            const absentList = Array.from(allStudents).filter(student => !presentStudents.has(student));

            attendanceResults.innerHTML = `
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Attendance Summary</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                        <h4 class="text-xl font-bold text-green-700 mb-2">Present (${presentList.length})</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            ${presentList.map(student => `<li class="text-green-600">${student}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                        <h4 class="text-xl font-bold text-red-700 mb-2">Absent (${absentList.length})</h4>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            ${absentList.map(student => `<li class="text-red-600">${student}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h4 class="text-xl font-bold text-yellow-700 mb-2">Unknown Faces (${unknownFacesCount})</h4>
                        <p class="text-yellow-600 text-sm">Faces detected but not recognized (Distance > ${MATCH_THRESHOLD}).</p>
                    </div>
                </div>
            `;
            attendanceResults.classList.remove('hidden');
            statusMessage.textContent = `Attendance processed successfully! Total faces detected: ${resizedDetections.length}.`;
            recognizeButton.disabled = false;
        });

        // Initialize the app on page load
        window.onload = loadModels;
    </script>
</body>
</html>
