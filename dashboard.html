<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendrix - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.5.7/dist/face-api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Hide scrollbars on body */
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .image-container {
            position: relative;
            display: inline-block;
            margin-top: 1rem;
        }
        #outputCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">

    <aside class="w-64 bg-gray-900 text-gray-400 p-6 flex flex-col shadow-lg">
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-white">attendrix</h1>
        </div>
        <nav class="flex-1">
            <ul>
                <li class="mb-4">
                    <div class="text-xs uppercase font-semibold text-gray-500 tracking-wider">Menu</div>
                </li>
                <li class="mb-2">
                    <a href="#" class="flex justify-between items-center py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="toggleDropdown(event)">
                        <span>Class</span>
                        <i class="fas fa-caret-down text-sm"></i>
                    </a>
                    <ul class="ml-4 mt-2 space-y-2 hidden">
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classA')">Class A</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classB')">Class B</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classC')">Class C</a></li>
                        <li><a href="#" class="block py-2 px-4 rounded-md text-sm hover:bg-gray-700 transition duration-300" onclick="showAttendanceContent('classD')">Class D</a></li>
                    </ul>
                </li>
                <li class="mb-2">
                    <a href="#" class="block py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="showContent('attendanceReport')">Attendance Report</a>
                </li>
                <li class="mb-2">
                    <a href="#" class="block py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="showContent('settings')">Settings</a>
                </li>
                <li class="mb-2">
                    <a href="#" class="block py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300" onclick="showContent('help')">Help</a>
                </li>
            </ul>
        </nav>
    </aside>

    <div class="flex-1 p-8 overflow-y-auto">
        <header class="bg-white rounded-lg shadow-md p-4 mb-8 flex justify-end items-center">
            <nav>
                <ul class="flex items-center space-x-6 text-gray-600 font-medium">
                    <li><a href="#" class="hover:text-indigo-600 transition duration-300" onclick="showContent('dashboard')">Home</a></li>
                </ul>
            </nav>
        </header>

        <div id="dashboardContent" class="content-section">
            <div class="p-8 bg-white rounded-lg shadow-md h-full">
                <h2 class="text-3xl font-bold mb-4 text-gray-800">Welcome to your Dashboard</h2>
                <p class="text-gray-600">Please select a class from the menu to manage attendance.</p>
            </div>
        </div>

        <div id="attendanceContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800" id="attendanceTitle">Class Attendance</h2>
            
            <div class="card mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">1. Upload Known Faces (Student Dataset)</h3>
                <p class="text-gray-500 mb-4">Select multiple images of the students in this class.</p>
                <input type="file" id="knownFacesInput" accept="image/*" multiple class="w-full text-gray-700 bg-gray-100 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer">
                <div id="knownFacesContainer" class="mt-4 flex flex-wrap gap-4"></div>
            </div>
            
            <div class="flex justify-center gap-4 mb-8">
                <button id="recognizeButton" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out disabled:opacity-50" disabled>
                    Take Attendance
                </button>
            </div>

            <div class="card mb-8">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">2. Upload Group Photo</h3>
                <p class="text-gray-500 mb-4">Select the group photo you want to scan and identify faces in.</p>
                <input type="file" id="groupPhotoInput" accept="image/jpeg" class="w-full text-gray-700 bg-gray-100 rounded-lg p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer">
                <div class="image-container mx-auto" id="groupPhotoContainer">
                    <img id="groupPhoto" class="max-w-full h-auto rounded-lg">
                    <canvas id="outputCanvas"></canvas>
                </div>
            </div>

            <div id="statusMessage" class="text-center text-green-600 mb-4 font-semibold"></div>
            <div id="attendanceResults" class="hidden mt-8"></div>
        </div>
        
        <div id="attendanceReportContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Attendance Report</h2>
            <p class="text-gray-600 mb-6">Here is a summary of your class attendance history.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Present</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Absent</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">2025-09-19</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Class A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">28</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">2</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600"><a href="#">View</a></td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">2025-09-18</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Class B</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">25</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">5</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600"><a href="#">View</a></td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">2025-09-17</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Class A</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">30</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">0</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600"><a href="#">View</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="settingsContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Settings</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">User Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="profileName" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="profileName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-2" placeholder="Your Name">
                        </div>
                        <div>
                            <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="profileEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-2" placeholder="your.email@example.com">
                        </div>
                        <button class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-300">Save Profile</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Display</h3>
                    <div class="flex items-center">
                        <input type="checkbox" id="darkModeToggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" onchange="toggleDarkMode()">
                        <label for="darkModeToggle" class="ml-2 block text-sm text-gray-700">Enable Dark Mode</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="helpContent" class="content-section hidden p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Help & Support</h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Frequently Asked Questions</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-800">How does the AI attendance system work?</h4>
                            <p class="text-gray-600">Our system uses facial recognition technology to identify students from a single image. It compares the faces in the image to a pre-registered database of student photos for the class, automatically marking who is present.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800">What file types can I upload?</h4>
                            <p class="text-gray-600">Currently, the system only supports JPG images for attendance processing.</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800">Is my data secure?</h4>
                            <p class="text-gray-600">Yes, we prioritize the security of your data. All images and student information are encrypted and stored securely.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentClassId = '';
        const studentDatabase = {
            classA: ['ganesh', 'sai', 'madhan'],
            classB: ['Kevin', 'Lisa', 'Mike', 'Nancy', 'Oscar', 'Paul', 'Quinn', 'Rachel', 'Sam', 'Tina'],
            classC: ['Umar', 'Vicky', 'Will', 'Xena', 'Yara', 'Zane', 'Alex', 'Bella', 'Cody', 'Diana'],
            classD: ['Ethan', 'Fiona', 'George', 'Hannah', 'Isaac', 'Jasmine', 'Kyle', 'Laura', 'Mark', 'Nora']
        };

        const knownFacesInput = document.getElementById('knownFacesInput');
        const groupPhotoInput = document.getElementById('groupPhotoInput');
        const knownFacesContainer = document.getElementById('knownFacesContainer');
        const groupPhotoImg = document.getElementById('groupPhoto');
        const outputCanvas = document.getElementById('outputCanvas');
        const recognizeButton = document.getElementById('recognizeButton');
        const statusMessage = document.getElementById('statusMessage');
        const attendanceTitle = document.getElementById('attendanceTitle');
        const attendanceResults = document.getElementById('attendanceResults');
        
        let labeledDescriptors = [];
        let faceMatcher;

        async function loadModels() {
            statusMessage.textContent = 'Loading AI models... please wait';
            try {
                await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                statusMessage.textContent = 'Models loaded successfully! Select known faces and a group photo.';
            } catch (error) {
                console.error("Failed to initialize:", error);
                statusMessage.textContent = "Initialization failed. Please check your internet connection and try again.";
            }
        }

        function showContent(contentId) {
            const allContentSections = document.querySelectorAll('.content-section');
            allContentSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(contentId + 'Content').classList.remove('hidden');
        }

        window.toggleDropdown = (event) => {
            event.preventDefault();
            const dropdown = event.target.closest('li').querySelector('ul');
            dropdown.classList.toggle('hidden');
        };

        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
        };

        window.showAttendanceContent = (classId) => {
            currentClassId = classId;
            showContent('attendance');
            attendanceTitle.textContent = `${classId.charAt(0).toUpperCase() + classId.slice(1)} Attendance`;
            statusMessage.textContent = 'Select known faces and a group photo.';
            clearAttendanceView();
        };
        
        function clearAttendanceView() {
            knownFacesInput.value = null;
            groupPhotoInput.value = null;
            knownFacesContainer.innerHTML = '';
            groupPhotoImg.src = '';
            const ctx = outputCanvas.getContext('2d');
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            attendanceResults.classList.add('hidden');
            recognizeButton.disabled = true;
        }

        function resizeImage(img, maxWidth = 600, maxHeight = 600) {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > height) {
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            return canvas;
        }

        async function createLabeledFaceDescriptors(files) {
            const descriptors = [];
            let facesFound = 0;
            statusMessage.textContent = `Processing known faces for ${currentClassId}...`;
            knownFacesContainer.innerHTML = '';
            for (const file of files) {
                const label = file.name.split('.')[0];
                try {
                    const img = await faceapi.bufferToImage(file);
                    const resizedCanvas = resizeImage(img);
                    const detection = await faceapi.detectSingleFace(resizedCanvas).withFaceLandmarks().withFaceDescriptor();

                    if (detection) {
                        descriptors.push(new faceapi.LabeledFaceDescriptors(label, [new Float32Array(detection.descriptor)]));
                        const imgPreview = document.createElement('img');
                        imgPreview.src = URL.createObjectURL(file);
                        imgPreview.alt = label;
                        imgPreview.className = "w-24 h-24 object-cover rounded-full border-2 border-green-500 shadow";
                        knownFacesContainer.appendChild(imgPreview);
                        facesFound++;
                    } else {
                        console.log(`Could not detect face in image: ${file.name}`);
                    }
                } catch (e) {
                    console.error(`Error processing file ${file.name}:`, e);
                }
            }
            if (facesFound === 0) {
                statusMessage.textContent = 'No faces detected in the uploaded known faces. Please try again with clear photos.';
            } else {
                statusMessage.textContent = `${facesFound} known faces processed. Ready for recognition.`;
                labeledDescriptors = descriptors;
            }
            checkReadyToRecognize();
        }

        function checkReadyToRecognize() {
            if (labeledDescriptors.length > 0 && groupPhotoImg.src) {
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.7);
                recognizeButton.disabled = false;
            } else {
                recognizeButton.disabled = true;
            }
        }

        knownFacesInput.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                createLabeledFaceDescriptors(files);
            }
        });

        groupPhotoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const imageUrl = URL.createObjectURL(file);
                groupPhotoImg.src = imageUrl;
                groupPhotoImg.onload = () => {
                    outputCanvas.width = groupPhotoImg.width;
                    outputCanvas.height = groupPhotoImg.height;
                    checkReadyToRecognize();
                };
            }
        });
        
        recognizeButton.addEventListener('click', async () => {
            if (!groupPhotoImg.src || labeledDescriptors.length === 0) {
                statusMessage.textContent = "Please upload both a group photo and known faces.";
                return;
            }
            statusMessage.textContent = 'Scanning group photo...';
            
            const detections = await faceapi.detectAllFaces(groupPhotoImg, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptors();
            
            if (detections.length === 0) {
                statusMessage.textContent = 'No faces detected in the group photo. Please upload a different image.';
                return;
            }
            
            const resizedDetections = faceapi.resizeResults(detections, { width: groupPhotoImg.width, height: groupPhotoImg.height });
            
            const ctx = outputCanvas.getContext('2d');
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            faceapi.matchDimensions(outputCanvas, { width: groupPhotoImg.width, height: groupPhotoImg.height });

            const presentStudents = new Set();
            const allStudents = new Set(studentDatabase[currentClassId]);

            resizedDetections.forEach(detection => {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                const box = detection.detection.box;
                const label = bestMatch.label;
                const distance = Math.round(bestMatch.distance * 100) / 100;
                const drawLabel = `${label} (${distance})`;
                
                const drawBox = new faceapi.draw.DrawBox(box, { label: drawLabel });
                drawBox.draw(outputCanvas);
                
                if (label !== 'unknown') {
                    presentStudents.add(label);
                }
            });

            const presentList = Array.from(presentStudents);
            const absentList = Array.from(allStudents).filter(student => !presentStudents.has(student));
            
            // Display results
            attendanceResults.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Present Students (${presentList.length})</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${presentList.map(student => `<li class="text-green-600 font-medium">${student}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Absent Students (${absentList.length})</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${absentList.map(student => `<li class="text-red-600 font-medium">${student}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            attendanceResults.classList.remove('hidden');
            statusMessage.textContent = `Attendance processed successfully for ${currentClassId}.`;
        });

        window.onload = loadModels;
    </script>
</body>
</html>


